<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>–†–µ–¥–∞–∫—Ç–æ—Ä ‚Äî Pair (–∫–∞–Ω–∞—Ç)</title>

  <style>
    :root{
      --bg:#0b0b0d; --card:#121215; --ink:#f1f1f1; --muted:#b8b8b8;
      --stroke:#26262a; --acc:#ffd700; --acc2:#ffbf00;
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(255,215,0,.10), transparent 60%),
        radial-gradient(900px 500px at 80% 0%, rgba(0,240,255,.06), transparent 55%),
        var(--bg);
      color:var(--ink);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }
    header{
      position:sticky; top:0; z-index:5;
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
      padding:14px 18px;
      border-bottom:1px solid var(--stroke);
      background: rgba(11,11,13,.88);
      backdrop-filter: blur(10px);
    }
    header h1{
      margin:0; font-size:18px; font-weight:900;
      color:var(--acc); display:flex; align-items:center; gap:10px;
    }
    .pill{
      font-size:12px; padding:6px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      color: rgba(255,255,255,.85);
      white-space:nowrap;
    }

    main{
      display:grid;
      grid-template-columns: 520px 1fr;
      gap:22px;
      padding:18px;
      max-width:1560px;
      margin:0 auto;
      align-items:start;
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      padding:16px;
      box-shadow: 0 0 30px rgba(255,215,0,.08);
    }
    .card h2{margin:0 0 12px; font-size:16px; color:var(--acc); font-weight:900;}
    .section{
      border:1px solid rgba(255,255,255,.06);
      background: rgba(0,0,0,.18);
      border-radius: 14px;
      padding:14px;
      margin-top:12px;
    }
    .section:first-child{margin-top:0}
    label{display:block; margin:10px 0 6px; font-size:14px; font-weight:800;}
    input[type=text], input[type=url], input[type=number], textarea, select{
      width:100%;
      background:#0f0f12; color:#fff;
      border:1px solid rgba(255,255,255,.16);
      border-radius:12px;
      padding:10px 12px;
      font-size:14px;
      outline:none;
    }
    textarea{min-height:74px; resize:vertical}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:14px}
    .hint{color:var(--muted); font-size:12px; margin-top:8px; line-height:1.45}
    .divider{height:1px; background: rgba(255,255,255,.06); margin:14px 0}
    button{
      background: linear-gradient(90deg, var(--acc2), var(--acc));
      color:#0b0b0d;
      border:none; border-radius:14px;
      font-weight:900;
      padding:12px 14px;
      cursor:pointer;
      transition:transform .12s ease, box-shadow .15s ease;
      font-size:14px;
      box-shadow: 0 10px 30px rgba(255,215,0,.18);
    }
    button:hover{transform: translateY(-1px); box-shadow: 0 14px 34px rgba(255,215,0,.22)}
    .btn-ghost{
      background: rgba(255,255,255,.06);
      color:#fff;
      border:1px solid rgba(255,255,255,.14);
      box-shadow:none;
    }
    .btn-mini{padding:10px 12px; border-radius:12px; font-size:13px}
    .toolbar{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    }
    .k{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; opacity:.9}
    .danger{background: rgba(255,70,70,.18); border:1px solid rgba(255,70,70,.35); color:#fff}

    /* preview area */
    #stageWrap{position:relative; width:100%; aspect-ratio: 16/9; border-radius:18px; overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
      background: radial-gradient(900px 500px at 30% 20%, rgba(255,215,0,.10), transparent 65%),
                  radial-gradient(900px 500px at 70% 0%, rgba(0,240,255,.06), transparent 55%),
                  rgba(0,0,0,.22);
      box-shadow: var(--shadow);
    }
    #stage{
      position:absolute; inset:0;
      user-select:none;
      touch-action:none;
    }
    #svg{
      position:absolute; inset:0;
      width:100%; height:100%;
      pointer-events:none;
      opacity:1;
      transition: opacity .12s ease;
    }
    .anchor{
      position:absolute;
      width:20px; height:20px;
      border-radius:999px;
      border:2px solid rgba(255,255,255,.55);
      background: rgba(0,0,0,.35);
      box-shadow: 0 0 14px rgba(255,215,0,.25);
      transform: translate(-50%,-50%);
      cursor:grab;
      display:flex; align-items:center; justify-content:center;
      font-size:11px; font-weight:900;
    }
    .anchor.left{box-shadow:0 0 16px rgba(0,240,255,.25); border-color: rgba(0,240,255,.65)}
    .anchor.right{box-shadow:0 0 16px rgba(255,215,0,.25); border-color: rgba(255,215,0,.70)}
    .anchor.selected{outline:3px solid rgba(255,255,255,.22)}
    .anchor:active{cursor:grabbing}

    .pairList{
      display:flex; flex-direction:column; gap:8px;
      margin-top:10px;
    }
    .pairItem{
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      padding:10px 12px; border-radius:14px;
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.08);
      font-weight:800;
    }
    .pairItem small{opacity:.75; font-weight:700}
    .pairItem button{box-shadow:none}
  </style>
</head>

<body>
<header>
  <h1>üßµ Pair ‚Äî –†–µ–¥–∞–∫—Ç–æ—Ä <span class="pill">–∫–∞–Ω–∞—Ç</span></h1>
  <span class="pill" id="statusPill">–ì–æ—Ç–æ–≤</span>
</header>

<main>
  <!-- LEFT -->
  <section class="card">
    <div class="section">
      <h2>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>

      <div class="row">
        <div>
          <label>–ó–∞–≥–æ–ª–æ–≤–æ–∫ (–¥–ª—è id)</label>
          <input id="title" type="text" placeholder="My Pair Game" value="pair-game">
        </div>
        <div>
          <label>–ê–≤—Ç–æ–ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–∏ –≤—Å–µ—Ö —Å–≤—è–∑–µ–π</label>
          <select id="autoCheck">
            <option value="1" selected>–î–∞</option>
            <option value="0">–ù–µ—Ç</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label>–¢–æ–ª—â–∏–Ω–∞ –∫–∞–Ω–∞—Ç–∞</label>
          <input id="ropeWidth" type="number" min="8" max="40" value="18">
        </div>
        <div>
          <label>–ü—Ä–æ–≤–∏—Å–∞–Ω–∏–µ (px)</label>
          <input id="ropeSag" type="number" min="0" max="220" value="70">
        </div>
      </div>

      <div class="row">
        <div>
          <label>–§–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç</label>
          <input id="finalText" type="text" value="üéâ –û—Ç–ª–∏—á–Ω–æ! –í—Å–µ –ø–∞—Ä—ã —Å–æ–≤–ø–∞–ª–∏!">
        </div>
        <div>
          <label>–ö–∞—Ä—Ç–∏–Ω–∫–∞ —Ñ–∏–¥–±–µ–∫–∞ (URL, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
          <input id="finalImg" type="url" placeholder="https://.../chest.png">
        </div>
      </div>

      <div class="hint">
        –°–ª–µ–≤–∞ –∏ —Å–ø—Ä–∞–≤–∞ ‚Äî —Ç–æ—á–∫–∏. –í —Ä–µ–∂–∏–º–µ <b>+2</b>: –∫–ª–∏–∫–Ω–∏ <b>–ª–µ–≤—É—é</b> —Ç–æ—á–∫—É ‚Üí –∫–ª–∏–∫–Ω–∏ <b>–ø—Ä–∞–≤—É—é</b> —Ç–æ—á–∫—É. –¢–∞–∫ –¥–æ–±–∞–≤–ª—è–µ—à—å –ª—é–±–æ–µ —á–∏—Å–ª–æ –ø–∞—Ä.
      </div>
    </div>

    <div class="section">
      <h2>üß© –¢–æ—á–∫–∏ –∏ –ø–∞—Ä—ã</h2>

      <div class="toolbar">
        <button class="btn-ghost btn-mini" id="btnAddLeft">+ —Å–ª–µ–≤–∞</button>
        <button class="btn-ghost btn-mini" id="btnAddRight">+ —Å–ø—Ä–∞–≤–∞</button>
        <button class="btn-ghost btn-mini" id="btnRemove">‚àí —É–¥–∞–ª–∏—Ç—å —Ç–æ—á–∫—É</button>

        <button class="btn-mini" id="btnPairMode">+2 —Ä–µ–∂–∏–º –ø–∞—Ä</button>
        <button class="btn-ghost btn-mini danger" id="btnClearPairs">–û—á–∏—Å—Ç–∏—Ç—å –ø–∞—Ä—ã</button>

        <span class="pill k" id="pairHint">–†–µ–∂–∏–º –ø–∞—Ä: –≤—ã–∫–ª</span>
      </div>

      <div class="divider"></div>

      <label>–ü–∞—Ä—ã (–¥–ª—è main):</label>
      <div class="pairList" id="pairsList"></div>

      <div class="hint">
        –ï—Å–ª–∏ –ª–∏–Ω–∏–∏ –º–µ—à–∞—é—Ç, –ø–æ–∫–∞ —Ç—ã –¥–≤–∏–≥–∞–µ—à—å —Ç–æ—á–∫—É ‚Äî –æ–Ω–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏–≥–ª—É—à–∞—é—Ç—Å—è –≤–æ –≤—Ä–µ–º—è drag.
      </div>
    </div>

    <div class="section">
      <h2>üöÄ –ü—É–±–ª–∏–∫–∞—Ü–∏—è</h2>

      <div class="row">
        <button class="btn-ghost btn-mini" id="btnTest">üîé –í–∞–ª–∏–¥–∞—Ü–∏—è JSON</button>
        <button class="btn-ghost btn-mini" id="btnCopy">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å iframe</button>
      </div>

      <label style="margin-top:12px;">iframe –¥–ª—è Genially</label>
      <textarea id="iframeOut" readonly placeholder="–ù–∞–∂–º–∏ ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –ø–æ–ª—É—á–∏—Ç—å iframe¬ª"></textarea>

      <div style="margin-top:12px;">
        <button id="btnSave">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –ø–æ–ª—É—á–∏—Ç—å iframe</button>
      </div>

      <div class="hint">
        –ü—É–±–ª–∏–∫–∞—Ü–∏—è –∏–¥—ë—Ç —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–µ—Ä –∫–∞–∫ –≤ —Ç–≤–æ–∏—Ö ¬´Utki¬ª. –ü–æ—Å–ª–µ ‚Äî –ø–æ–¥–æ–∂–¥–∏ 30‚Äì60 —Å–µ–∫—É–Ω–¥, –ø–æ–∫–∞ GitHub Pages –ø–æ–¥—Ö–≤–∞—Ç–∏—Ç JSON.
      </div>
    </div>
  </section>

  <!-- RIGHT -->
  <section class="card">
    <h2>üß™ –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –Ω–∞ —Å–ª–∞–π–¥–µ (16:9)</h2>
    <div id="stageWrap">
      <svg id="svg" viewBox="0 0 1920 1080" preserveAspectRatio="none">
        <defs>
          <!-- –∫–∞–Ω–∞—Ç–æ-–ø–æ–¥–æ–±–Ω–∞—è —Ñ–∞–∫—Ç—É—Ä–∞ -->
          <pattern id="ropeTex" width="10" height="10" patternUnits="userSpaceOnUse" patternTransform="rotate(18)">
            <rect width="10" height="10" fill="#caa15a"></rect>
            <path d="M0 2 H10" stroke="#b38b45" stroke-width="2" opacity="0.75"></path>
            <path d="M0 6 H10" stroke="#d8b46a" stroke-width="2" opacity="0.55"></path>
            <path d="M0 9 H10" stroke="#9a7539" stroke-width="1" opacity="0.35"></path>
          </pattern>

          <filter id="ropeShadow" x="-30%" y="-30%" width="160%" height="160%">
            <feDropShadow dx="0" dy="6" stdDeviation="6" flood-color="#000" flood-opacity="0.35"/>
          </filter>
        </defs>
      </svg>

      <div id="stage"></div>
    </div>

    <div class="hint" style="margin-top:12px;">
      –ü–æ–¥—Å–∫–∞–∑–∫–∞: —Ç–æ—á–∫–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞—é—Ç—Å—è. –í —Ä–µ–∂–∏–º–µ +2 –ø–∞—Ä—ã —Å–æ–∑–¥–∞—é—Ç—Å—è –∫–ª–∏–∫–∞–º–∏ (–Ω–µ drag).
    </div>
  </section>
</main>

<script>
  const $ = (s) => document.querySelector(s);

  // === publish (–∫–∞–∫ —É Utki) ===
  const ENDPOINT    = "https://server-kjnn.onrender.com/publish";
  const PUBLISH_KEY = "nika_read_pub_2025";
  const BASE_MAIN   = "https://nikashum93.github.io/pair/main.html";
  const JSON_FOLDER = "data"; // –ø—É–±–ª–∏–∫—É–µ–º –≤ texts/data –∫–∞–∫ —É —Ç–µ–±—è

  // ===== state =====
  const anchors = []; // {id, side:'left'|'right', x:0..1, y:0..1}
  const pairs = [];   // {leftId,rightId}
  let selectedId = null;

  let pairAddMode = false;
  let pairFrom = null; // leftId
  let draggingId = null;

  // ===== helpers =====
  function uid(prefix='p'){
    return prefix + Math.random().toString(16).slice(2,10);
  }
  function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }
  function stageRect(){ return $('#stageWrap').getBoundingClientRect(); }

  function setStatus(t){
    $('#statusPill').textContent = t;
  }

  function ropeD(x1,y1,x2,y2,sag){
    const mx = (x1+x2)/2;
    const my = (y1+y2)/2 + sag;
    return `M ${x1} ${y1} Q ${mx} ${my} ${x2} ${y2}`;
  }

  function drawRope(svg, x1,y1,x2,y2, good=null){
    const w = Math.max(8, Math.min(40, parseInt($('#ropeWidth').value||'18',10)));
    const sag = Math.max(0, Math.min(220, parseInt($('#ropeSag').value||'70',10)));

    const d = ropeD(x1,y1,x2,y2,sag);

    const g = document.createElementNS("http://www.w3.org/2000/svg","g");

    // shadow
    const sh = document.createElementNS("http://www.w3.org/2000/svg","path");
    sh.setAttribute("d", d);
    sh.setAttribute("fill","none");
    sh.setAttribute("stroke","#000");
    sh.setAttribute("stroke-width", w + 6);
    sh.setAttribute("stroke-linecap","round");
    sh.setAttribute("opacity","0.16");
    sh.setAttribute("filter","url(#ropeShadow)");

    // body texture
    const body = document.createElementNS("http://www.w3.org/2000/svg","path");
    body.setAttribute("d", d);
    body.setAttribute("fill","none");
    body.setAttribute("stroke", "url(#ropeTex)");
    body.setAttribute("stroke-width", w);
    body.setAttribute("stroke-linecap","round");
    body.setAttribute("stroke-linejoin","round");

    // highlight
    const hl = document.createElementNS("http://www.w3.org/2000/svg","path");
    hl.setAttribute("d", d);
    hl.setAttribute("fill","none");
    hl.setAttribute("stroke", "#fff");
    hl.setAttribute("stroke-width", Math.max(2, w*0.22));
    hl.setAttribute("stroke-linecap","round");
    hl.setAttribute("opacity","0.28");

    // correctness overlay (—Ç–æ–Ω–∫–∞—è –ø–æ–¥—Å–≤–µ—Ç–∫–∞ —Å–≤–µ—Ä—Ö—É)
    if (good === true || good === false){
      const ov = document.createElementNS("http://www.w3.org/2000/svg","path");
      ov.setAttribute("d", d);
      ov.setAttribute("fill","none");
      ov.setAttribute("stroke", good ? "#00e676" : "#ff5252");
      ov.setAttribute("stroke-width", Math.max(3, w*0.35));
      ov.setAttribute("stroke-linecap","round");
      ov.setAttribute("opacity","0.75");
      g.appendChild(ov);
    }

    g.appendChild(sh);
    g.appendChild(body);
    g.appendChild(hl);

    svg.appendChild(g);
    return g;
  }

  function render(){
    const stage = $('#stage');
    stage.innerHTML = '';
    const svg = $('#svg');
    // clear ropes, keep defs
    [...svg.querySelectorAll('g')].forEach(g=>g.remove());

    // render anchors
    for(const a of anchors){
      const el = document.createElement('div');
      el.className = `anchor ${a.side}` + (a.id===selectedId ? ' selected' : '');
      el.dataset.id = a.id;
      el.textContent = a.side === 'left' ? 'L' : 'R';

      const W = stage.clientWidth;
      const H = stage.clientHeight;
      el.style.left = (a.x * W) + 'px';
      el.style.top  = (a.y * H) + 'px';

      el.addEventListener('pointerdown', (e)=>onAnchorDown(e, a.id));
      el.addEventListener('click', (e)=>onAnchorClick(e, a.id));

      stage.appendChild(el);
    }

    // render pair ropes (preview)
    const rect = stageRect();
    const W = rect.width, H = rect.height;
    for(const pr of pairs){
      const L = anchors.find(x=>x.id===pr.leftId);
      const R = anchors.find(x=>x.id===pr.rightId);
      if(!L || !R) continue;
      const x1 = L.x * 1920, y1 = L.y * 1080;
      const x2 = R.x * 1920, y2 = R.y * 1080;
      drawRope(svg, x1,y1,x2,y2, null);
    }

    renderPairsList();
  }

  function renderPairsList(){
    const list = $('#pairsList');
    list.innerHTML = '';

    if(!pairs.length){
      const d = document.createElement('div');
      d.className = 'hint';
      d.textContent = '–ü–æ–∫–∞ –Ω–µ—Ç –ø–∞—Ä. –í–∫–ª—é—á–∏ —Ä–µ–∂–∏–º +2 –∏ –∫–ª–∏–∫–∞–π: —Å–ª–µ–≤–∞ ‚Üí —Å–ø—Ä–∞–≤–∞.';
      list.appendChild(d);
      return;
    }

    pairs.forEach((p, idx)=>{
      const item = document.createElement('div');
      item.className = 'pairItem';
      item.innerHTML = `<div>–ü–∞—Ä–∞ ${idx+1}: <small>${p.leftId}</small> ‚Üí <small>${p.rightId}</small></div>`;
      const del = document.createElement('button');
      del.className = 'btn-ghost btn-mini';
      del.textContent = '–£–¥–∞–ª–∏—Ç—å';
      del.addEventListener('click', ()=>{
        pairs.splice(idx,1);
        render();
      });
      item.appendChild(del);
      list.appendChild(item);
    });
  }

  // ===== interaction =====
  function onAnchorClick(e, id){
    e.stopPropagation();

    // pairing mode: click L then R
    if(pairAddMode){
      const a = anchors.find(x=>x.id===id);
      if(!a) return;

      if(!pairFrom){
        if(a.side !== 'left') return;
        pairFrom = id;
        $('#pairHint').innerHTML = `–†–µ–∂–∏–º –ø–∞—Ä: –≤—ã–±—Ä–∞–Ω–∞ <b>${pairFrom}</b>, —Ç–µ–ø–µ—Ä—å –∫–ª–∏–∫–Ω–∏ —Ç–æ—á–∫—É —Å–ø—Ä–∞–≤–∞`;
        return;
      } else {
        if(a.side !== 'right') return;
        addPair(pairFrom, id);
        pairFrom = null; // ‚úÖ –ö–õ–Æ–ß: —Å–±—Ä–æ—Å, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –¥–æ–±–∞–≤–ª—è—Ç—å –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ
        $('#pairHint').innerHTML = `–ü–∞—Ä–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ ‚úÖ. –í—ã–±–µ—Ä–∏ —Å–ª–µ–¥—É—é—â—É—é —Ç–æ—á–∫—É —Å–ª–µ–≤–∞`;
        render();
        return;
      }
    }

    // normal select
    selectedId = id;
    render();
  }

  function onAnchorDown(e, id){
    e.preventDefault();
    e.stopPropagation();
    selectedId = id;
    draggingId = id;

    // while dragging fade ropes
    $('#svg').style.opacity = '0.18';

    const el = e.currentTarget;
    el.setPointerCapture(e.pointerId);

    function move(ev){
      const rect = stageRect();
      const nx = clamp((ev.clientX - rect.left)/rect.width, 0, 1);
      const ny = clamp((ev.clientY - rect.top)/rect.height, 0, 1);
      const a = anchors.find(x=>x.id===id);
      if(a){ a.x = nx; a.y = ny; }
      render();
    }
    function up(ev){
      try{ el.releasePointerCapture(e.pointerId); }catch(_){}
      $('#svg').style.opacity = '1';
      draggingId = null;
      window.removeEventListener('pointermove', move);
      window.removeEventListener('pointerup', up);
      render();
    }

    window.addEventListener('pointermove', move);
    window.addEventListener('pointerup', up);
  }

  function addAnchor(side){
    const id = uid(side==='left'?'L':'R');
    const x = side==='left' ? 0.22 : 0.78;
    const y = 0.25 + Math.random()*0.5;
    anchors.push({id, side, x, y});
    selectedId = id;
    render();
  }

  function removeSelected(){
    if(!selectedId) return;

    const idx = anchors.findIndex(a=>a.id===selectedId);
    if(idx<0) return;

    // remove anchor
    const removed = anchors.splice(idx,1)[0];

    // remove pairs referencing it
    for(let i=pairs.length-1;i>=0;i--){
      if(pairs[i].leftId===removed.id || pairs[i].rightId===removed.id) pairs.splice(i,1);
    }

    selectedId = null;
    // also clear pairFrom if it was this one
    if(pairFrom===removed.id) pairFrom=null;

    render();
  }

  function addPair(leftId, rightId){
    // ensure exists + correct sides
    const L = anchors.find(a=>a.id===leftId && a.side==='left');
    const R = anchors.find(a=>a.id===rightId && a.side==='right');
    if(!L || !R) return;

    // prevent duplicates: one left -> one right (overwrite behavior)
    for(let i=pairs.length-1;i>=0;i--){
      if(pairs[i].leftId===leftId || pairs[i].rightId===rightId){
        pairs.splice(i,1);
      }
    }
    pairs.push({leftId, rightId});
  }

  function clearPairs(){
    pairs.length = 0;
    pairFrom = null;
    $('#pairHint').textContent = pairAddMode ? '–†–µ–∂–∏–º –ø–∞—Ä: –≤—ã–±–µ—Ä–∏ —Ç–æ—á–∫—É —Å–ª–µ–≤–∞' : '–†–µ–∂–∏–º –ø–∞—Ä: –≤—ã–∫–ª';
    render();
  }

  function togglePairMode(){
    pairAddMode = !pairAddMode;
    pairFrom = null;
    $('#btnPairMode').textContent = pairAddMode ? '‚úÖ +2 —Ä–µ–∂–∏–º –ø–∞—Ä' : '+2 —Ä–µ–∂–∏–º –ø–∞—Ä';
    $('#pairHint').textContent = pairAddMode ? '–†–µ–∂–∏–º –ø–∞—Ä: –≤—ã–±–µ—Ä–∏ —Ç–æ—á–∫—É —Å–ª–µ–≤–∞' : '–†–µ–∂–∏–º –ø–∞—Ä: –≤—ã–∫–ª';
    setStatus(pairAddMode ? '–†–µ–∂–∏–º –ø–∞—Ä' : '–ì–æ—Ç–æ–≤');
  }

  // ===== config + publish =====
  function makeId(){
    const base = ($('#title').value || 'pair').trim().toLowerCase()
      .normalize('NFKD').replace(/[\u0300-\u036f]/g,'')
      .replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'')
      .slice(0,40) || 'pair';

    const d=new Date(), p=n=>String(n).padStart(2,'0');
    const stamp = `${d.getFullYear()}${p(d.getMonth()+1)}${p(d.getDate())}-${p(d.getHours())}${p(d.getMinutes())}${p(d.getSeconds())}`;
    return `${base}-${stamp}`;
  }

  function collectConfig(){
    return {
      version: 1,
      title: ($('#title').value || 'pair').trim(),
      autoCheck: $('#autoCheck').value === '1',
      style: {
        ropeWidth: Math.max(8, Math.min(40, parseInt($('#ropeWidth').value||'18',10))),
        ropeSag:   Math.max(0, Math.min(220, parseInt($('#ropeSag').value||'70',10))),
      },
      feedback: {
        finalText: ($('#finalText').value || '').trim(),
        finalImage: ($('#finalImg').value || '').trim()
      },
      anchors: anchors.map(a=>({id:a.id, side:a.side, x:a.x, y:a.y})),
      pairs: pairs.map(p=>({leftId:p.leftId, rightId:p.rightId}))
    };
  }

  function validate(cfg){
    const L = cfg.anchors.filter(a=>a.side==='left').length;
    const R = cfg.anchors.filter(a=>a.side==='right').length;
    if(L===0 || R===0) return '–î–æ–±–∞–≤—å —Ç–æ—á–∫–∏ —Å–ª–µ–≤–∞ –∏ —Å–ø—Ä–∞–≤–∞.';
    if(cfg.pairs.length===0) return '–î–æ–±–∞–≤—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –ø–∞—Ä—É (—Ä–µ–∂–∏–º +2).';
    // ensure all pairs valid
    for(const p of cfg.pairs){
      const l = cfg.anchors.find(a=>a.id===p.leftId && a.side==='left');
      const r = cfg.anchors.find(a=>a.id===p.rightId && a.side==='right');
      if(!l || !r) return '–ï—Å—Ç—å –ø–∞—Ä–∞ —Å –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Ç–æ—á–∫–æ–π. –£–¥–∞–ª–∏/—Å–æ–∑–¥–∞–π –∑–∞–Ω–æ–≤–æ.';
    }
    return null;
  }

  async function publish(){
    setStatus('–ü—É–±–ª–∏–∫—É—é‚Ä¶');

    const cfg = collectConfig();
    const err = validate(cfg);
    if(err){ alert(err); setStatus('–û—à–∏–±–∫–∞'); return; }

    const id = makeId();
    const payload = {
      id,
      mode: "json",
      folder: JSON_FOLDER,
      content: JSON.stringify(cfg, null, 2)
    };

    try{
      const res = await fetch(ENDPOINT, {
        method: "POST",
        headers: {"Content-Type":"application/json","X-Publish-Key":PUBLISH_KEY},
        body: JSON.stringify(payload)
      });
      if(!res.ok){
        const t = await res.text().catch(()=>res.statusText);
        throw new Error(t || 'Server error');
      }

      const iframe = `<iframe src="${BASE_MAIN}?id=${encodeURIComponent(id)}" style="border:0;width:100%;height:100%;" allow="autoplay" allowfullscreen></iframe>`;
      $('#iframeOut').value = iframe;

      setStatus('–ì–æ—Ç–æ–≤–æ ‚úÖ');
      alert('–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ! –ü–æ–¥–æ–∂–¥–∏ 30‚Äì60 —Å–µ–∫—É–Ω–¥, –ø–æ–∫–∞ —Å—Å—ã–ª–∫–∞ –æ–±–Ω–æ–≤–∏—Ç—Å—è.');
    }catch(e){
      setStatus('–°–µ—Ç—å/–æ—à–∏–±–∫–∞');
      alert('–°–µ—Ç—å/—Å–µ—Ä–≤–µ—Ä: ' + e.message);
    }
  }

  function copyIframe(){
    const v = $('#iframeOut').value.trim();
    if(!v){ alert('–°–Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω–∏, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å iframe.'); return; }
    navigator.clipboard.writeText(v).catch(()=>{});
  }

  function quickTest(){
    const cfg = collectConfig();
    const err = validate(cfg);
    if(err){ alert(err); return; }
    alert('JSON –≤–∞–ª–∏–¥–µ–Ω ‚úÖ\n–¢–æ—á–µ–∫: ' + cfg.anchors.length + '\n–ü–∞—Ä: ' + cfg.pairs.length);
    console.log(cfg);
  }

  // ===== init =====
  $('#btnAddLeft').addEventListener('click', ()=>addAnchor('left'));
  $('#btnAddRight').addEventListener('click', ()=>addAnchor('right'));
  $('#btnRemove').addEventListener('click', removeSelected);
  $('#btnPairMode').addEventListener('click', togglePairMode);
  $('#btnClearPairs').addEventListener('click', clearPairs);

  $('#btnSave').addEventListener('click', publish);
  $('#btnCopy').addEventListener('click', copyIframe);
  $('#btnTest').addEventListener('click', quickTest);

  window.addEventListener('resize', render);

  // —Å—Ç–∞—Ä—Ç: –ø–æ 2 —Ç–æ—á–∫–∏ –∫–∞–∫ —É–¥–æ–±–Ω—ã–π —à–∞–±–ª–æ–Ω
  addAnchor('left'); addAnchor('left');
  addAnchor('right'); addAnchor('right');
  // –∏ —Å—Ä–∞–∑—É –≤–∫–ª—é—á–∏–º —Ä–µ–∂–∏–º –ø–∞—Ä
  togglePairMode();
  render();
</script>
</body>
</html>
