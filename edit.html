<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–†–µ–¥–∞–∫—Ç–æ—Ä ‚Äî Pair (Matching)</title>

  <style>
    :root{
      --acc:#ffd700;
      --acc2:#00f0ff;
      --bg: rgba(10,10,12,.10); /* –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Ñ–æ–Ω –¥–ª—è —Ä–∞–±–æ—Ç—ã –Ω–∞ —Å–ª–∞–π–¥–µ */
      --panel: rgba(15,15,20,.88);
      --panel2: rgba(18,18,24,.88);
      --stroke: rgba(255,255,255,.14);
      --ink:#fff;
      --muted: rgba(255,255,255,.72);
      --radius:16px;
      --shadow: 0 10px 26px rgba(0,0,0,.35);
      --shadow2: 0 0 22px rgba(255,215,0,.12);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background: transparent;
      overflow:hidden;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--ink);
    }

    /* —Å–ª–æ–π –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏ */
    #stage{
      position:absolute; inset:0;
      background: var(--bg);
    }

    /* –ü–∞–Ω–µ–ª—å —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ */
    #panel{
      position:absolute;
      top:14px; left:14px;
      width:min(420px, calc(100vw - 28px));
      max-height: calc(100vh - 28px);
      overflow:auto;
      padding:14px;
      border-radius: var(--radius);
      background: linear-gradient(180deg, var(--panel), var(--panel2));
      border:1px solid var(--stroke);
      box-shadow: var(--shadow), var(--shadow2);
      backdrop-filter: blur(10px);
      z-index: 50;
    }

    #panel.drag-hide{opacity:0; pointer-events:none; transition:opacity .08s ease}
    #panel h1{
      margin:0 0 8px;
      font-size:16px;
      font-weight:900;
      color: var(--acc);
      display:flex;
      gap:10px;
      align-items:center;
    }
    .pill{
      font-size:12px;
      padding:5px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.85);
      white-space:nowrap;
    }

    .section{
      margin-top:12px;
      padding:12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.20);
    }
    .section h2{
      margin:0 0 10px;
      font-size:13px;
      font-weight:900;
      color: rgba(255,255,255,.92);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }

    label{display:block; margin:10px 0 6px; font-size:12.5px; font-weight:800; color:#fff}
    input[type="text"], input[type="url"], input[type="number"], select, textarea{
      width:100%;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.25);
      color:#fff;
      padding:10px 12px;
      font-size:13px;
      outline:none;
    }
    textarea{min-height:86px; resize:vertical}
    input:focus,textarea:focus,select:focus{
      border-color: rgba(255,215,0,.55);
      box-shadow: 0 0 0 3px rgba(255,215,0,.14);
    }

    .row{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .row3{display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px}
    .hint{font-size:12px; color:var(--muted); margin-top:8px; line-height:1.35}

    .btnbar{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-top:10px;
    }
    button{
      border:none;
      border-radius: 14px;
      padding:10px 12px;
      font-weight:900;
      cursor:pointer;
      background: linear-gradient(90deg, var(--acc), #ffbf00);
      color:#0b0b0d;
      box-shadow: 0 10px 24px rgba(255,215,0,.18);
      font-size:13px;
    }
    button:hover{transform: translateY(-1px)}
    .ghost{
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.14);
      color:#fff;
      box-shadow:none;
    }
    .danger{
      background: rgba(255,77,77,.18);
      border:1px solid rgba(255,77,77,.35);
      color:#fff;
      box-shadow:none;
    }
    .mini{padding:9px 10px; border-radius:12px}

    .seg{
      display:flex; gap:8px; align-items:center;
    }
    .seg button{
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.14);
      color:#fff;
      box-shadow:none;
      padding:9px 10px;
      border-radius:999px;
    }
    .seg button.active{
      background: rgba(255,215,0,.14);
      border-color: rgba(255,215,0,.38);
      color:#fff;
      box-shadow: 0 0 18px rgba(255,215,0,.12);
    }

    /* –¢–æ—á–∫–∏ */
    .anchor{
      position:absolute;
      width:22px; height:22px;
      border-radius:999px;
      transform: translate(-50%,-50%);
      background: rgba(255,255,255,.16);
      border:2px solid rgba(255,255,255,.60);
      box-shadow: 0 0 18px rgba(0,240,255,.20);
      cursor: grab;
      user-select:none;
      z-index: 10;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:11px;
      font-weight:900;
      color:#fff;
      text-shadow: 0 2px 8px rgba(0,0,0,.6);
    }
    .anchor.left{border-color: rgba(0,240,255,.85); box-shadow:0 0 18px rgba(0,240,255,.25)}
    .anchor.right{border-color: rgba(255,215,0,.85); box-shadow:0 0 18px rgba(255,215,0,.25)}
    .anchor.selected{outline:3px solid rgba(255,255,255,.35)}
    .anchor.dragging{cursor: grabbing; z-index: 9999; outline: 3px solid rgba(255,255,255,.22)}

    /* –∫–æ–≥–¥–∞ —Ç—è–Ω–µ–º ‚Äî –≤—Å—ë –æ—Å—Ç–∞–ª—å–Ω–æ–µ ‚Äú—Å–≤–æ—Ä–∞—á–∏–≤–∞–µ–º‚Äù, —á—Ç–æ–± –Ω–µ –º–µ—à–∞–ª–æ */
    body.dragging .anchor:not(.dragging){
      opacity:.12;
      pointer-events:none;
    }

    /* –ü–∞–Ω–µ–ª—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –±—ã—Å—Ç—Ä—ã—Ö –∫–Ω–æ–ø–æ–∫ */
    #quick{
      position:absolute;
      right:14px; top:14px;
      display:flex; flex-direction:column; gap:10px;
      z-index: 60;
    }
    #quick .qbtn{
      width:46px; height:46px;
      border-radius: 16px;
      display:flex; align-items:center; justify-content:center;
      font-size:18px;
      font-weight:900;
      background: rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.14);
      box-shadow: var(--shadow);
      color:#fff;
      cursor:pointer;
      user-select:none;
    }
    #quick .qbtn:hover{transform: translateY(-1px)}
    #quick .qbtn.active{
      border-color: rgba(255,215,0,.38);
      box-shadow: 0 0 22px rgba(255,215,0,.12), var(--shadow);
    }

    /* —Å–ø–∏—Å–æ–∫ –ø–∞—Ä */
    .pairs{
      display:flex; flex-direction:column; gap:8px;
      margin-top:10px;
    }
    .pairRow{
      display:grid;
      grid-template-columns: 1fr 26px 1fr 28px;
      gap:8px;
      align-items:center;
      padding:10px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
    }
    .pairRow select{
      background: rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.14);
      font-weight:900;
    }
    .pairRow .arrow{opacity:.9; font-weight:900; text-align:center}
    .pairRow .del{
      width:28px; height:28px;
      border-radius: 10px;
      display:flex; align-items:center; justify-content:center;
      background: rgba(255,77,77,.18);
      border:1px solid rgba(255,77,77,.35);
      cursor:pointer;
      user-select:none;
    }

    /* –≤—ã–≤–æ–¥ iframe */
    #iframeOut{
      height: 92px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size:12px;
    }
  </style>
</head>

<body>
  <div id="stage"></div>

  <!-- –±—ã—Å—Ç—Ä—ã–µ –∫–Ω–æ–ø–∫–∏ (+)(-)(+2) -->
  <div id="quick" aria-label="–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã">
    <div class="qbtn" id="btnPlus" title="–î–æ–±–∞–≤–∏—Ç—å —Ç–æ—á–∫—É">+</div>
    <div class="qbtn" id="btnMinus" title="–£–¥–∞–ª–∏—Ç—å —Ç–æ—á–∫—É">‚àí</div>
    <div class="qbtn" id="btnPair" title="–î–æ–±–∞–≤–∏—Ç—å –ø–∞—Ä—É">+2</div>
  </div>

  <aside id="panel">
    <h1>üß∑ Pair ‚Äî –†–µ–¥–∞–∫—Ç–æ—Ä <span class="pill">–Ω–∞ —Å–ª–∞–π–¥–µ</span></h1>

    <div class="section">
      <h2>üöÄ –ü—É–±–ª–∏–∫–∞—Ü–∏—è <span class="pill" id="statusPill">–ì–æ—Ç–æ–≤</span></h2>

      <label>–ù–∞–∑–≤–∞–Ω–∏–µ (–¥–ª—è ID)</label>
      <input type="text" id="title" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: matching-animals" value="matching">

      <div class="btnbar">
        <button class="ghost" id="btnCalibrate">–†–µ–∂–∏–º —Ç–æ—á–µ–∫: –í–ö–õ/–í–´–ö–õ</button>
        <button id="btnOkPublish">OK ‚Äî —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –ø–æ–ª—É—á–∏—Ç—å iframe</button>
      </div>

      <label style="margin-top:12px;">iframe –¥–ª—è Genially (–∏–≥—Ä–∞)</label>
      <textarea id="iframeOut" readonly placeholder="–ü–æ—è–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ OK‚Ä¶"></textarea>

      <div class="btnbar">
        <button class="ghost mini" id="btnCopy">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
        <button class="ghost mini" id="btnTest">üîé –ü—Ä–æ–≤–µ—Ä–∏—Ç—å JSON</button>
      </div>

      <div class="hint">
        –†–∞–±–æ—Ç–∞–π –≤ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–µ Genially: —Å—Ç–∞–≤—å —Ç–æ—á–∫–∏ –ø–æ–≤–µ—Ä—Ö –æ–±—ä–µ–∫—Ç–æ–≤, –Ω–∞–∂–∏–º–∞–π OK ‚Äî –ø–æ–ª—É—á–∏—à—å iframe –∏–≥—Ä—ã.
      </div>
    </div>

    <div class="section">
      <h2>üß≤ –¢–æ—á–∫–∏</h2>

      <div class="seg">
        <button class="active" id="sideLeft">–õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞</button>
        <button id="sideRight">–ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞</button>
      </div>

      <label style="margin-top:10px;">
        <input type="checkbox" id="showLabels" checked>
        –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø–æ–¥–ø–∏—Å–∏ –Ω–∞ —Ç–æ—á–∫–∞—Ö (L1/R1‚Ä¶)
      </label>

      <label>
        <input type="checkbox" id="hidePanelWhileDrag" checked>
        –ü—Ä—è—Ç–∞—Ç—å –ø–∞–Ω–µ–ª—å –≤–æ –≤—Ä–µ–º—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è —Ç–æ—á–∫–∏
      </label>

      <div class="row" style="margin-top:10px;">
        <div>
          <label>
            <input type="checkbox" id="snapToGrid">
            –ú–∞–≥–Ω–∏—Ç –∫ —Å–µ—Ç–∫–µ
          </label>
        </div>
        <div>
          <label>–®–∞–≥ —Å–µ—Ç–∫–∏ (px)</label>
          <input type="number" id="gridStep" value="8" min="2" max="40">
        </div>
      </div>

      <div class="hint">
        –ü–æ–¥—Å–∫–∞–∑–∫–∏: Shift ‚Äî –¥–≤–∏–∂–µ–Ω–∏–µ –ø–æ –æ—Å–∏, Alt ‚Äî –≤–∫–ª—é—á–∏—Ç—å –º–∞–≥–Ω–∏—Ç –∫ —Å–µ—Ç–∫–µ ‚Äú–Ω–∞ –≤—Ä–µ–º—è‚Äù.
      </div>
    </div>

    <div class="section">
      <h2>üîó –ü–∞—Ä—ã (—á—Ç–æ —Å —á–µ–º –º—ç—Ç—á–∏—Ç—Å—è)</h2>

      <div class="hint" id="pairHint">
        –ù–∞–∂–º–∏ <b>+2</b> –∏ –≤—ã–±–µ—Ä–∏ —Ç–æ—á–∫—É —Å–ª–µ–≤–∞ ‚Üí —Ç–æ—á–∫—É —Å–ø—Ä–∞–≤–∞, —á—Ç–æ–±—ã –±—ã—Å—Ç—Ä–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–∞—Ä—É.
        –õ–∏–±–æ –¥–æ–±–∞–≤–ª—è–π –ø–∞—Ä—ã –≤ —Å–ø–∏—Å–∫–µ.
      </div>

      <div class="btnbar">
        <button class="ghost mini" id="btnAddPair">–î–æ–±–∞–≤–∏—Ç—å –ø–∞—Ä—É –≤ —Å–ø–∏—Å–æ–∫</button>
        <button class="danger mini" id="btnClearPairs">–û—á–∏—Å—Ç–∏—Ç—å –ø–∞—Ä—ã</button>
      </div>

      <div class="pairs" id="pairsList"></div>
    </div>

    <div class="section">
      <h2>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–≥—Ä—ã</h2>

      <div class="row">
        <div>
          <label>–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ</label>
          <select id="connectMode">
            <option value="drag" selected>–ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ–º (–∫–∞–∫ Wordwall)</option>
            <option value="click">–ö–ª–∏–∫-–∫–ª–∏–∫</option>
          </select>
        </div>
        <div>
          <label>–ü—Ä–æ–≤–µ—Ä–∫–∞</label>
          <select id="checkMode">
            <option value="button" selected>–ü–æ –∫–Ω–æ–ø–∫–µ ¬´–ü—Ä–æ–≤–µ—Ä–∏—Ç—å¬ª</option>
            <option value="instant">–°—Ä–∞–∑—É –ø—Ä–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–∏</option>
          </select>
        </div>
      </div>

      <label style="margin-top:10px;">
        <input type="checkbox" id="oneToOne" checked>
        –û–¥–∏–Ω-–∫-–æ–¥–Ω–æ–º—É (—Ç–æ—á–∫–∞ –º–æ–∂–µ—Ç –∏–º–µ—Ç—å —Ç–æ–ª—å–∫–æ 1 —Å–≤—è–∑—å)
      </label>

      <div class="row" style="margin-top:10px;">
        <div>
          <label>–û—à–∏–±–∫–∞</label>
          <select id="wrongBehavior">
            <option value="mark" selected>–ü–æ–¥—Å–≤–µ—Ç–∏—Ç—å –∫—Ä–∞—Å–Ω—ã–º</option>
            <option value="shakeRemove">–¢—Ä—è—Ö–Ω—É—Ç—å –∏ —É–¥–∞–ª–∏—Ç—å —Å–≤—è–∑—å</option>
          </select>
        </div>
        <div>
          <label>
            <input type="checkbox" id="showButtons" checked>
            –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –∫–Ω–æ–ø–∫–∏ ¬´–ü—Ä–æ–≤–µ—Ä–∏—Ç—å/–°–±—Ä–æ—Å¬ª
          </label>
        </div>
      </div>
    </div>

    <div class="section">
      <h2>üé® –í–µ—Ä—ë–≤–æ—á–∫–∏ (SVG)</h2>

      <div class="row">
        <div>
          <label>–¢–æ–ª—â–∏–Ω–∞</label>
          <input type="number" id="ropeWidth" value="8" min="2" max="24">
        </div>
        <div>
          <label>–ö—Ä–∏–≤–∏–∑–Ω–∞ (0‚Äì0.7)</label>
          <input type="number" id="curve" value="0.35" step="0.05" min="0" max="0.7">
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div>
          <label>–¶–≤–µ—Ç –≤–µ—Ä—ë–≤–∫–∏</label>
          <input type="text" id="ropeColor" value="#66ccff">
        </div>
        <div>
          <label>
            <input type="checkbox" id="glow" checked>
            –ù–µ–æ–Ω–æ–≤–æ–µ —Å–≤–µ—á–µ–Ω–∏–µ
          </label>
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div>
          <label>–ü—Ä–∞–≤–∏–ª—å–Ω–æ</label>
          <input type="text" id="correctColor" value="#5cff9d">
        </div>
        <div>
          <label>–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ</label>
          <input type="text" id="wrongColor" value="#ff4d4d">
        </div>
      </div>

      <label style="margin-top:10px;">
        <input type="checkbox" id="drawAnim" checked>
        –ê–Ω–∏–º–∞—Ü–∏—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è –≤–µ—Ä—ë–≤–∫–∏
      </label>
    </div>

    <div class="section">
      <h2>üéâ –§–∏–Ω–∞–ª—å–Ω—ã–π —Ñ–∏–¥–±–µ–∫</h2>

      <label>
        <input type="checkbox" id="feedbackEnabled" checked>
        –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ñ–∏–¥–±–µ–∫
      </label>

      <label>–†–µ–∂–∏–º</label>
      <select id="feedbackMode">
        <option value="both" selected>–ö–∞—Ä—Ç–∏–Ω–∫–∞ + —Ç–µ–∫—Å—Ç</option>
        <option value="text">–¢–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç</option>
        <option value="image">–¢–æ–ª—å–∫–æ –∫–∞—Ä—Ç–∏–Ω–∫–∞</option>
      </select>

      <label style="margin-top:10px;">–¢–µ–∫—Å—Ç</label>
      <input type="text" id="finalText" value="üéâ –ú–æ–ª–æ–¥–µ—Ü! –í—Å–µ –ø–∞—Ä—ã –Ω–∞–π–¥–µ–Ω—ã.">

      <label style="margin-top:10px;">–ö–∞—Ä—Ç–∏–Ω–∫–∞ (URL)</label>
      <input type="url" id="finalImage" placeholder="https://.../chest.png">

      <div class="hint">–§–∏–¥–±–µ–∫ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è, –∫–æ–≥–¥–∞ –≤—Å–µ –ø–∞—Ä—ã —Å–æ–µ–¥–∏–Ω–µ–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ.</div>
    </div>
  </aside>

  <script>
    const $ = (s) => document.querySelector(s);

    // –ü—É–±–ª–∏–∫–∞—Ü–∏—è ‚Äî –∫–∞–∫ —É —Ç–µ–±—è
    const ENDPOINT    = "https://server-kjnn.onrender.com/publish";
    const PUBLISH_KEY = "nika_read_pub_2025";
    const BASE_MAIN   = "https://nikashum93.github.io/pair/main.html";
    const JSON_FOLDER = "data";

    // –°–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
    let calibrationOn = true;
    let activeSide = 'left'; // left|right
    let selectedAnchorId = null;

    let pairAddMode = false;
    let pairFrom = null;

    // anchors —Ö—Ä–∞–Ω–∏–º –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö
    // anchors: { id: {x:0..1, y:0..1, side:'left'|'right'} }
    const anchors = {};
    // –ø–∞—Ä—ã –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤
    const pairs = []; // {from:'L1', to:'R1'}

    // UI refs
    const stage = $('#stage');
    const panel = $('#panel');
    const statusPill = $('#statusPill');

    // ---------- helpers ----------
    function setStatus(t){ statusPill.textContent = t; }

    function clamp01(v){ return Math.max(0, Math.min(1, v)); }
    function snap(v, step){ return Math.round(v / step) * step; }

    function stageRect(){ return stage.getBoundingClientRect(); }

    function toPx(ax){
      const r = stageRect();
      return { x: ax.x * r.width, y: ax.y * r.height };
    }
    function toRel(pxX, pxY){
      const r = stageRect();
      return { x: clamp01(pxX / r.width), y: clamp01(pxY / r.height) };
    }

    function nextId(side){
      const pref = (side === 'left') ? 'L' : 'R';
      let n = 1;
      while(anchors[pref + n]) n++;
      return pref + n;
    }

    function refreshSideButtons(){
      $('#sideLeft').classList.toggle('active', activeSide === 'left');
      $('#sideRight').classList.toggle('active', activeSide === 'right');
    }

    function setQuickActive(){
      $('#btnPair').classList.toggle('active', pairAddMode);
    }

    function setLabelsVisibility(){
      const on = $('#showLabels').checked;
      Object.values(anchors).forEach(a=>{
        const el = document.querySelector(`.anchor[data-id="${a.id}"]`);
        if(el) el.textContent = on ? a.id : '';
      });
    }

    function selectAnchor(id){
      selectedAnchorId = id;
      document.querySelectorAll('.anchor').forEach(el=>el.classList.remove('selected'));
      const el = document.querySelector(`.anchor[data-id="${id}"]`);
      if(el) el.classList.add('selected');
    }

    // ---------- anchors UI ----------
    function createAnchor(side){
      const id = nextId(side);
      const rel = { x: 0.5, y: 0.5 }; // –ø–æ —Ü–µ–Ω—Ç—Ä—É (–ø–æ—Ç–æ–º –ø–µ—Ä–µ—Ç–∞—â–∏—à—å)
      anchors[id] = { id, side, x: rel.x, y: rel.y };

      const el = document.createElement('div');
      el.className = 'anchor ' + side;
      el.dataset.id = id;
      el.textContent = $('#showLabels').checked ? id : '';
      stage.appendChild(el);

      // –ø–æ–∑–∏—Ü–∏—è
      updateAnchorEl(id);

      // –∫–ª–∏–∫ ‚Äî –≤—ã–±–æ—Ä / –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–∞—Ä—ã
      el.addEventListener('click', (e)=>{
        e.stopPropagation();
        if(!calibrationOn) return;

        selectAnchor(id);

        // —Ä–µ–∂–∏–º +2: L -> R
        if(pairAddMode){
          const a = anchors[id];
          if(!pairFrom){
            if(a.side !== 'left'){ return; }
            pairFrom = id;
            $('#pairHint').innerHTML = `–í—ã–±—Ä–∞–Ω–∞ <b>${pairFrom}</b>. –¢–µ–ø–µ—Ä—å –∫–ª–∏–∫–Ω–∏ —Ç–æ—á–∫—É —Å–ø—Ä–∞–≤–∞.`;
            return;
          }else{
            if(a.side !== 'right'){ return; }
            addPair(pairFrom, id);
            pairFrom = null;
            $('#pairHint').innerHTML = `–ü–∞—Ä–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ ‚úÖ. –ú–æ–∂–Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å (—Å–ª–µ–≤–∞ ‚Üí —Å–ø—Ä–∞–≤–∞).`;
            return;
          }
        }
      });

      // drag
      enableDrag(el);

      refreshPairsUI();
      return id;
    }

    function updateAnchorEl(id){
      const a = anchors[id];
      if(!a) return;
      const el = document.querySelector(`.anchor[data-id="${id}"]`);
      if(!el) return;
      const px = toPx(a);
      el.style.left = px.x + 'px';
      el.style.top  = px.y + 'px';
    }

    function removeAnchor(id){
      if(!id || !anchors[id]) return;

      // —É–¥–∞–ª–∏—Ç—å –ø–∞—Ä—ã, –≥–¥–µ —É—á–∞—Å—Ç–≤—É–µ—Ç
      for(let i = pairs.length - 1; i >= 0; i--){
        if(pairs[i].from === id || pairs[i].to === id) pairs.splice(i,1);
      }

      // —É–¥–∞–ª–∏—Ç—å —ç–ª–µ–º–µ–Ω—Ç
      const el = document.querySelector(`.anchor[data-id="${id}"]`);
      if(el) el.remove();

      delete anchors[id];
      if(selectedAnchorId === id) selectedAnchorId = null;

      refreshPairsUI();
    }

    function enableDrag(el){
      let dragging = false;
      let pointerId = null;

      function onDown(e){
        if(!calibrationOn) return;
        dragging = true;
        pointerId = e.pointerId;
        el.setPointerCapture(pointerId);

        document.body.classList.add('dragging');
        el.classList.add('dragging');

        if($('#hidePanelWhileDrag').checked){
          panel.classList.add('drag-hide');
        }

        // —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –ø–æ—Å—Ç–∞–≤–∏—Ç—å –≤ –ª—é–±–æ–µ –º–µ—Å—Ç–æ: –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º ‚Äú–ø–æ–ø–∞–¥–∞–Ω–∏–µ –Ω–∞ –¥—Ä—É–≥–∏–µ —Ç–æ—á–∫–∏‚Äù
        e.preventDefault();
        e.stopPropagation();
      }

      function onMove(e){
        if(!dragging) return;
        const r = stageRect();

        // –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤–Ω—É—Ç—Ä–∏ stage
        let x = e.clientX - r.left;
        let y = e.clientY - r.top;

        // Shift ‚Äî –¥–≤–∏–∂–µ–Ω–∏–µ –ø–æ –æ—Å–∏
        if(e.shiftKey){
          // –≤—ã–±–∏—Ä–∞–µ–º ‚Äú–∫–∞–∫–∞—è –æ—Å—å –∞–∫—Ç–∏–≤–Ω–µ–µ‚Äù
          // –ø—Ä–æ—Å—Ç–∞—è –ª–æ–≥–∏–∫–∞: –µ—Å–ª–∏ —Å–∏–ª—å–Ω–µ–µ —Å–º–µ—â–µ–Ω–∏–µ –ø–æ X ‚Äî —Ñ–∏–∫—Å–∏—Ä—É–µ–º Y; –∏–Ω–∞—á–µ —Ñ–∏–∫—Å–∏—Ä—É–µ–º X
          // —á—Ç–æ–±—ã –Ω–µ –ø—Ä—ã–≥–∞–ª–æ, —Ñ–∏–∫—Å–∏—Ä—É–µ–º –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ç–µ–∫—É—â–µ–π –ø–æ–∑–∏—Ü–∏–∏
          const id = el.dataset.id;
          const a = anchors[id];
          const cur = toPx(a);
          const dx = Math.abs(x - cur.x);
          const dy = Math.abs(y - cur.y);
          if(dx > dy) y = cur.y; else x = cur.x;
        }

        // –ú–∞–≥–Ω–∏—Ç: —á–µ–∫–±–æ–∫—Å –∏–ª–∏ Alt ‚Äú–Ω–∞ –≤—Ä–µ–º—è‚Äù
        const snapOn = $('#snapToGrid').checked || e.altKey;
        if(snapOn){
          const step = Math.max(2, Math.min(40, parseInt($('#gridStep').value || '8',10)));
          x = snap(x, step);
          y = snap(y, step);
        }

        // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö
        const rel = toRel(x, y);
        const id = el.dataset.id;
        anchors[id].x = rel.x;
        anchors[id].y = rel.y;

        updateAnchorEl(id);
      }

      function onUp(){
        if(!dragging) return;
        dragging = false;
        document.body.classList.remove('dragging');
        el.classList.remove('dragging');
        panel.classList.remove('drag-hide');
      }

      el.addEventListener('pointerdown', onDown);
      window.addEventListener('pointermove', onMove);
      window.addEventListener('pointerup', onUp);
      window.addEventListener('pointercancel', onUp);
    }

    // –ø—Ä–∏ —Ä–µ—Å–∞–π–∑–µ ‚Äî –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ—Ä–∏—Å—É–µ–º –ø–æ–∑–∏—Ü–∏–∏ –ø–æ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–º –ø—Ä–æ—Ü–µ–Ω—Ç–∞–º
    window.addEventListener('resize', ()=>{
      Object.keys(anchors).forEach(updateAnchorEl);
    });

    // ---------- pairs UI ----------
    function addPair(from, to){
      if(!from || !to) return;
      // –∏–∑–±–µ–≥–∞–µ–º –¥—É–±–ª–µ–π
      if(pairs.some(p => p.from === from && p.to === to)) return;
      pairs.push({from, to});
      refreshPairsUI();
    }

    function refreshPairsUI(){
      const list = $('#pairsList');
      list.innerHTML = '';

      const leftIds  = Object.values(anchors).filter(a=>a.side==='left').map(a=>a.id).sort();
      const rightIds = Object.values(anchors).filter(a=>a.side==='right').map(a=>a.id).sort();

      pairs.forEach((p, idx)=>{
        const row = document.createElement('div');
        row.className = 'pairRow';

        const sFrom = document.createElement('select');
        leftIds.forEach(id=>{
          const o = document.createElement('option');
          o.value=id; o.textContent=id;
          if(id===p.from) o.selected=true;
          sFrom.appendChild(o);
        });

        const arrow = document.createElement('div');
        arrow.className='arrow';
        arrow.textContent='‚Üí';

        const sTo = document.createElement('select');
        rightIds.forEach(id=>{
          const o = document.createElement('option');
          o.value=id; o.textContent=id;
          if(id===p.to) o.selected=true;
          sTo.appendChild(o);
        });

        const del = document.createElement('div');
        del.className='del';
        del.textContent='√ó';
        del.title='–£–¥–∞–ª–∏—Ç—å –ø–∞—Ä—É';

        sFrom.addEventListener('change', ()=>{ pairs[idx].from = sFrom.value; });
        sTo.addEventListener('change',   ()=>{ pairs[idx].to   = sTo.value; });

        del.addEventListener('click', ()=>{
          pairs.splice(idx,1);
          refreshPairsUI();
        });

        row.appendChild(sFrom);
        row.appendChild(arrow);
        row.appendChild(sTo);
        row.appendChild(del);
        list.appendChild(row);
      });

      // –µ—Å–ª–∏ –Ω–µ—Ç —Ç–æ—á–µ–∫ ‚Äî –ø–æ–¥—Å–∫–∞–∑–∫–∞
      if(!leftIds.length || !rightIds.length){
        $('#pairHint').innerHTML = `–î–æ–±–∞–≤—å —Ç–æ—á–∫–∏: –≤—ã–±–µ—Ä–∏ –∫–æ–ª–æ–Ω–∫—É (–ª–µ–≤–∞—è/–ø—Ä–∞–≤–∞—è) –∏ –Ω–∞–∂–∏–º–∞–π <b>+</b>.`;
      }
    }

    // ---------- config / publish ----------
    function makeIdFromTitle(){
      const t = ($('#title').value || 'matching').trim();
      const slug = t.toLowerCase()
        .normalize('NFKD').replace(/[\u0300-\u036f]/g,'')
        .replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'')
        .slice(0,40) || 'matching';
      const d=new Date(), p=n=>String(n).padStart(2,'0');
      const stamp = `${d.getFullYear()}${p(d.getMonth()+1)}${p(d.getDate())}-${p(d.getHours())}${p(d.getMinutes())}${p(d.getSeconds())}`;
      return `${slug}-${stamp}`;
    }

    function collectConfig(){
      // anchors —É–∂–µ –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö
      const outAnchors = {};
      Object.values(anchors).forEach(a=>{
        outAnchors[a.id] = { x:a.x, y:a.y, side:a.side };
      });

      const cfg = {
        version: 1,
        anchors: outAnchors,
        pairs: [...pairs],

        settings: {
          connectMode: $('#connectMode').value,     // drag|click
          checkMode: $('#checkMode').value,         // button|instant
          oneToOne: $('#oneToOne').checked,
          wrongBehavior: $('#wrongBehavior').value, // mark|shakeRemove
          showButtons: $('#showButtons').checked
        },

        style: {
          ropeWidth: Math.max(2, Math.min(24, parseInt($('#ropeWidth').value || '8',10))),
          curve: Math.max(0, Math.min(0.7, parseFloat($('#curve').value || '0.35'))),
          ropeColor: ($('#ropeColor').value || '#66ccff').trim(),
          correctColor: ($('#correctColor').value || '#5cff9d').trim(),
          wrongColor: ($('#wrongColor').value || '#ff4d4d').trim(),
          glow: $('#glow').checked,
          drawAnim: $('#drawAnim').checked
        },

        feedback: {
          enabled: $('#feedbackEnabled').checked,
          mode: $('#feedbackMode').value, // both|text|image
          text: ($('#finalText').value || '').trim(),
          image: ($('#finalImage').value || '').trim()
        }
      };

      return cfg;
    }

    function validate(cfg){
      const a = cfg.anchors || {};
      const left  = Object.keys(a).filter(id=>a[id].side==='left');
      const right = Object.keys(a).filter(id=>a[id].side==='right');
      if(left.length < 1 || right.length < 1) return '–ù—É–∂–Ω—ã —Ç–æ—á–∫–∏ –∏ —Å–ª–µ–≤–∞, –∏ —Å–ø—Ä–∞–≤–∞.';
      if(!cfg.pairs || cfg.pairs.length < 1) return '–î–æ–±–∞–≤—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –ø–∞—Ä—É (+2).';
      // –ø—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –≤—Å–µ –ø–∞—Ä—ã –≤–∞–ª–∏–¥–Ω—ã
      for(const p of cfg.pairs){
        if(!a[p.from] || !a[p.to]) return '–ï—Å—Ç—å –ø–∞—Ä–∞ —Å —É–¥–∞–ª—ë–Ω–Ω–æ–π —Ç–æ—á–∫–æ–π ‚Äî –ø—Ä–æ–≤–µ—Ä—å —Å–ø–∏—Å–æ–∫ –ø–∞—Ä.';
        if(a[p.from].side !== 'left' || a[p.to].side !== 'right') return '–ü–∞—Ä—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å–ª–µ–≤–∞ ‚Üí —Å–ø—Ä–∞–≤–∞.';
      }
      if(cfg.feedback?.enabled){
        const m = cfg.feedback.mode;
        if(m === 'image' && !cfg.feedback.image) return '–î–ª—è ‚Äú–¢–æ–ª—å–∫–æ –∫–∞—Ä—Ç–∏–Ω–∫–∞‚Äù –Ω—É–∂–Ω–∞ —Å—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫—É.';
        if(m === 'text' && !cfg.feedback.text) return '–î–ª—è ‚Äú–¢–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç‚Äù –Ω—É–∂–µ–Ω —Ç–µ–∫—Å—Ç.';
        if(m === 'both' && !cfg.feedback.text && !cfg.feedback.image) return '–í —Ä–µ–∂–∏–º–µ ‚Äú–ö–∞—Ä—Ç–∏–Ω–∫–∞ + —Ç–µ–∫—Å—Ç‚Äù –Ω—É–∂–µ–Ω —Ç–µ–∫—Å—Ç –∏–ª–∏ –∫–∞—Ä—Ç–∏–Ω–∫–∞.';
      }
      return null;
    }

    async function publish(){
      setStatus('–ü—É–±–ª–∏–∫—É—é‚Ä¶');
      const cfg = collectConfig();
      const err = validate(cfg);
      if(err){ alert(err); setStatus('–û—à–∏–±–∫–∞'); return; }

      const id = makeIdFromTitle();

      const payload = {
        id,
        mode: "json",
        folder: JSON_FOLDER,
        content: JSON.stringify(cfg, null, 2)
      };

      try{
        const res = await fetch(ENDPOINT, {
          method: "POST",
          headers: {
            "Content-Type":"application/json",
            "X-Publish-Key": PUBLISH_KEY
          },
          body: JSON.stringify(payload)
        });

        if(!res.ok){
          const t = await res.text().catch(()=>res.statusText);
          throw new Error(t || 'Server error');
        }

        const iframe = `<iframe src="${BASE_MAIN}?id=${encodeURIComponent(id)}" width="960" height="540" style="border:0;" allow="autoplay" allowfullscreen></iframe>`;
        $('#iframeOut').value = iframe;

        setStatus('–ì–æ—Ç–æ–≤–æ ‚úÖ');
        alert('–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ! –ü–æ–¥–æ–∂–¥–∏ 30‚Äì60 —Å–µ–∫—É–Ω–¥ –∏ –≤—Å—Ç–∞–≤–ª—è–π iframe –∏–≥—Ä—ã –≤ Genially.');
      }catch(e){
        setStatus('–°–µ—Ç—å/–æ—à–∏–±–∫–∞');
        alert('–°–µ—Ç—å/—Å–µ—Ä–≤–µ—Ä: ' + e.message);
      }
    }

    // ---------- UI wiring ----------
    function toggleCalibration(){
      calibrationOn = !calibrationOn;
      $('#btnCalibrate').textContent = '–†–µ–∂–∏–º —Ç–æ—á–µ–∫: ' + (calibrationOn ? '–í–ö–õ' : '–í–´–ö–õ');
      // –ø—Ä–∏ –≤—ã–∫–ª –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏ ‚Äî —Ç–æ—á–∫–∏ –Ω–µ –¥–≤–∏–≥–∞–µ–º, –Ω–æ –ø—É—Å—Ç—å –≤–∏–¥–Ω—ã
      setStatus('–ì–æ—Ç–æ–≤');
    }

    $('#sideLeft').addEventListener('click', ()=>{ activeSide='left'; refreshSideButtons(); });
    $('#sideRight').addEventListener('click', ()=>{ activeSide='right'; refreshSideButtons(); });

    $('#btnPlus').addEventListener('click', ()=>{
      const id = createAnchor(activeSide);
      selectAnchor(id);
      setLabelsVisibility();
    });
    $('#btnMinus').addEventListener('click', ()=>{
      const id = selectedAnchorId || (activeSide==='left'
        ? Object.keys(anchors).filter(k=>k.startsWith('L')).sort().pop()
        : Object.keys(anchors).filter(k=>k.startsWith('R')).sort().pop()
      );
      if(!id){ return; }
      removeAnchor(id);
      refreshPairsUI();
    });

    function togglePairMode(){
      pairAddMode = !pairAddMode;
      pairFrom = null;
      setQuickActive();
      $('#pairHint').innerHTML = pairAddMode
        ? '–†–µ–∂–∏–º <b>+2</b> –≤–∫–ª—é—á—ë–Ω: –∫–ª–∏–∫–Ω–∏ —Ç–æ—á–∫—É <b>—Å–ª–µ–≤–∞</b>, –∑–∞—Ç–µ–º —Ç–æ—á–∫—É <b>—Å–ø—Ä–∞–≤–∞</b>.'
        : '–ù–∞–∂–º–∏ <b>+2</b> –∏ –≤—ã–±–µ—Ä–∏ —Å–ª–µ–≤–∞ ‚Üí —Å–ø—Ä–∞–≤–∞, —á—Ç–æ–±—ã –±—ã—Å—Ç—Ä–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–∞—Ä—É.';
    }
    $('#btnPair').addEventListener('click', togglePairMode);

    $('#btnAddPair').addEventListener('click', ()=>{
      const leftIds  = Object.values(anchors).filter(a=>a.side==='left').map(a=>a.id).sort();
      const rightIds = Object.values(anchors).filter(a=>a.side==='right').map(a=>a.id).sort();
      if(!leftIds.length || !rightIds.length){ alert('–°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å —Ç–æ—á–∫–∏ —Å–ª–µ–≤–∞ –∏ —Å–ø—Ä–∞–≤–∞.'); return; }
      addPair(leftIds[0], rightIds[0]);
    });

    $('#btnClearPairs').addEventListener('click', ()=>{
      if(!confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –ø–∞—Ä—ã?')) return;
      pairs.splice(0, pairs.length);
      refreshPairsUI();
    });

    $('#showLabels').addEventListener('change', setLabelsVisibility);

    $('#btnCalibrate').addEventListener('click', toggleCalibration);
    $('#btnOkPublish').addEventListener('click', publish);

    $('#btnTest').addEventListener('click', ()=>{
      const cfg = collectConfig();
      const err = validate(cfg);
      if(err){ alert('–û—à–∏–±–∫–∞: ' + err); return; }
      alert('JSON –≤–∞–ª–∏–¥–µ–Ω ‚úÖ\n–¢–æ—á–µ–∫: ' + Object.keys(cfg.anchors).length + '\n–ü–∞—Ä: ' + cfg.pairs.length);
      console.log(cfg);
    });

    $('#btnCopy').addEventListener('click', async ()=>{
      const v = ($('#iframeOut').value || '').trim();
      if(!v){ alert('–°–Ω–∞—á–∞–ª–∞ –Ω–∞–∂–º–∏ OK ‚Äî —á—Ç–æ–±—ã –ø–æ—è–≤–∏–ª—Å—è iframe.'); return; }
      try{ await navigator.clipboard.writeText(v); }catch(_){}
    });

    // —Å—Ç–∞—Ä—Ç
    refreshSideButtons();
    setQuickActive();
    toggleCalibration(); // —Å–¥–µ–ª–∞–µ–º –í–ö–õ –Ω–∞ —Å—Ç–∞—Ä—Ç–µ
    toggleCalibration(); // —á—Ç–æ–±—ã —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ –±—ã–ª –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π
  </script>
</body>
</html>
